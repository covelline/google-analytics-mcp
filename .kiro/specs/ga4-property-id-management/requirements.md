# 要件ドキュメント

## はじめに

この機能は、既存のGoogle Analytics 4 MCPサーバーを拡張して、起動時に固定のGA4プロパティIDを指定する代わりに、動的にプロパティIDを管理できるようにします。これにより、ユーザーはMCPサーバーを再起動することなく、異なるGA4プロパティにアクセスできるようになります。また、google-analytics-adminライブラリを使用して、利用可能なGA4プロパティの一覧を取得し、LLMがレポート作成時に適切なプロパティIDを指定できるようにします。重要な変更点として、GA4データを取得する際にはプロパティIDの指定を必須とし、デフォルトプロパティIDの指定は不要とします。

## 要件

### 要件1: GA4プロパティ一覧の取得

**ユーザーストーリー:** GA4ユーザーとして、アクセス可能なすべてのGA4プロパティの一覧を取得し、それらの間で切り替えることができるようにしたい。

#### 受け入れ基準
1. WHEN ユーザーがMCPサーバーを起動する時、システムはOAuth2認証を使用してGoogle Analytics Adminライブラリにアクセスすること。
2. WHEN システムがGoogle Analytics Adminライブラリにアクセスする時、システムはユーザーがアクセス可能なすべてのGA4プロパティの一覧を取得すること。
3. WHEN プロパティ一覧を取得する時、システムは各プロパティのID、名前、および関連するアカウント情報を含めること。
4. WHEN プロパティ一覧の取得に失敗する時、システムは適切なエラーメッセージを表示し、フォールバックオプションを提供すること。
5. WHEN ユーザーが明示的にプロパティIDを指定する時、システムはそのプロパティIDを使用すること。

### 要件2: プロパティ選択ツールの提供

**ユーザーストーリー:** LLMユーザーとして、利用可能なGA4プロパティの一覧を取得し、レポート作成時に適切なプロパティを選択できるようにしたい。

#### 受け入れ基準
1. WHEN LLMがプロパティ一覧を要求する時、システムは利用可能なすべてのGA4プロパティの一覧を返すこと。
2. WHEN LLMがプロパティを選択する時、システムは選択されたプロパティIDを後続のGA4 API呼び出しで使用すること。
3. WHEN プロパティが選択されていない時、システムはデフォルトのプロパティ（最初に見つかったプロパティまたは設定で指定されたプロパティ）を使用すること。
4. WHEN LLMが無効なプロパティIDを指定する時、システムは適切なエラーメッセージを返し、有効なプロパティIDの一覧を提供すること。
5. WHEN LLMがプロパティの詳細情報を要求する時、システムは指定されたプロパティの詳細情報（名前、作成日、親アカウントなど）を返すこと。

### 要件3: GA4データ取得時のプロパティID指定

**ユーザーストーリー:** LLMユーザーとして、GA4データを取得する際に使用するプロパティIDを指定できるようにしたい。

#### 受け入れ基準
1. WHEN LLMがGA4データを要求する時、システムはプロパティIDの指定を必須とすること。
2. WHEN プロパティIDが指定されている時、システムは指定されたプロパティIDを使用してデータを取得すること。
3. WHEN プロパティIDが指定されていない時、システムは適切なエラーメッセージを返し、プロパティIDの指定が必要であることを通知すること。
4. WHEN 指定されたプロパティIDが無効な時、システムは適切なエラーメッセージを返し、有効なプロパティIDの一覧を提供すること。
5. WHEN プロパティIDが変更される時、システムは新しいプロパティIDを使用してGA4 API呼び出しを行うこと。

### 要件4: プロパティ情報の管理

**ユーザーストーリー:** GA4ユーザーとして、利用可能なプロパティの情報を効率的に管理し、LLMがレポート作成時に適切なプロパティを選択できるようにしたい。

#### 受け入れ基準
1. WHEN システムがプロパティ一覧を取得する時、システムはプロパティIDと名前のマッピングをメモリに保持すること。
2. WHEN LLMがプロパティ情報を要求する時、システムはキャッシュされた情報を返すこと。
3. WHEN プロパティ情報が古くなる可能性がある時、システムは定期的に情報を更新するか、明示的な更新メカニズムを提供すること。
4. WHEN LLMがプロパティ名でプロパティを参照する時、システムは対応するプロパティIDを解決できること。
5. WHEN 新しいプロパティが追加される時、システムはプロパティ一覧を更新する方法を提供すること。

### 要件5: エラー処理と後方互換性

**ユーザーストーリー:** 既存のユーザーとして、新機能が追加されても既存の機能が引き続き動作するようにしたい。

#### 受け入れ基準
1. WHEN Google Analytics Adminライブラリが利用できない時、システムは適切なエラーメッセージを表示し、ユーザーに必要なライブラリのインストール方法を案内すること。
2. WHEN プロパティ一覧の取得に失敗する時、システムは適切なエラーメッセージを表示し、トラブルシューティングの手順を提供すること。
3. WHEN 既存のGA4データ取得ツールが使用される時、システムはプロパティIDパラメータを必須として処理すること。
4. WHEN 新しいツールが呼び出される時、システムは古いバージョンのMCPクライアントとの互換性を維持すること。
5. WHEN システムがエラーを検出する時、システムは詳細なエラーメッセージをログに記録し、ユーザーに適切なフィードバックを提供すること。