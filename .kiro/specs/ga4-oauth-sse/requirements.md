# 要件ドキュメント

## はじめに

この機能は、既存のGoogle Analytics 4 MCPサーバーを修正して、LLMとの通信にHTTP-SSE（Server-Sent Events）を使用し、Googleの認証方法をサービスアカウントベースの認証からOAuth2に変更します。これにより、ユーザーはサービスアカウントのJSONファイルを必要とせず、ブラウザベースのOAuth2フローを通じて自分のGoogleアカウントで認証できるようになります。また、サーバーはClaude Desktopやその他のLLMクライアントとのHTTP-SSE通信をサポートするように更新されます。

## 要件

### 要件1: OAuth2認証

**ユーザーストーリー:** GA4ユーザーとして、サービスアカウントを作成・管理する必要がないように、OAuth2を使用してGoogleアカウントで認証したい。

#### 受け入れ基準

1. ユーザーがMCPサーバーを起動する時、システムはOAuth2認証のためのURLを提供すること。
2. ユーザーがOAuth2 URLにアクセスする時、システムはGoogleの認証ページにリダイレクトすること。
3. ユーザーがGoogle認証を完了する時、システムはOAuth2トークンを受け取り保存すること。
4. OAuth2トークンが期限切れになる時、システムはリフレッシュトークンが利用可能であれば自動的に更新すること。
5. システムがGA4データにアクセスする必要がある時、システムはサービスアカウント認証情報の代わりにOAuth2トークンを使用すること。
6. ユーザーが初めてサーバーを実行する時、システムはOAuth2セットアッププロセスを案内すること。
7. OAuth2トークンが保存される時、システムはMCPサーバーを実行しているディレクトリに安全に保存すること。

### 要件2: HTTP-SSE通信

**ユーザーストーリー:** Claude Desktopユーザーとして、GA4 MCPサーバーがHTTP-SSEで通信できるようにしたい。これにより、Claude Desktopやその他のLLMクライアントで使用できるようになる。

#### 受け入れ基準

1. MCPサーバーが起動する時、システムはSSEエンドポイントを持つHTTPサーバーを初期化すること。
2. LLMクライアントがSSEエンドポイントに接続する時、システムは永続的な接続を確立すること。
3. LLMクライアントがリクエストを送信する時、システムはそれを処理し、SSE接続を介して応答を送信すること。
4. システムが応答を送信する時、システムはSSEプロトコルに従ってフォーマットすること。
5. エラーが発生する時、システムはSSE接続を介して適切なエラーメッセージを送信すること。
6. 接続が閉じられる時、システムは適切にリソースをクリーンアップすること。

### 要件3: ローカルサーバー設定

**ユーザーストーリー:** ユーザーとして、MCPサーバーをローカルで設定・実行し、LLMクライアントに接続できるようにしたい。

#### 受け入れ基準

1. ユーザーがパッケージをインストールする時、システムはサーバーを起動するためのコマンドラインインターフェースを提供すること。
2. サーバーが起動する時、システムは設定可能なローカルポート（デフォルト：8000）でリッスンすること。
3. ユーザーがポートを変更したい時、システムは異なるポートを指定するためのコマンドラインオプションを提供すること。
4. サーバーが実行中の時、システムは動作状態を確認するためのステータスエンドポイントを提供すること。
5. ユーザーがサーバーを停止したい時、システムは終了シグナルを適切に処理すること。
6. サーバーが実行中の時、システムは重要なイベントをコンソールに記録すること。

### 要件4: MCPクライアント統合

**ユーザーストーリー:** LLMユーザーとして、Claude DesktopをGA4 MCPサーバーに接続し、自然言語でGA4データをクエリできるようにしたい。

#### 受け入れ基準

1. ユーザーがClaude Desktopを設定する時、システムはMCPサーバーへの接続手順を明確に提供すること。
2. Claude DesktopがMCPサーバーに接続する時、システムは利用可能なGA4ツールを登録すること。
3. ユーザーがGA4データについて質問する時、システムはリクエストを処理し、適切なデータを返すこと。
4. MCPサーバーが応答する時、システムはClaudeが理解して表示できる形式でデータをフォーマットすること。
5. Claude DesktopとMCPサーバー間の接続が失われる時、システムは明確なエラーメッセージを提供すること。

### 要件5: 後方互換性

**ユーザーストーリー:** 既存のユーザーとして、現在のセットアップを壊すことなくアップグレードできるように、新バージョンが既存のMCPクライアントとの互換性を維持してほしい。

#### 受け入れ基準

1. サーバーが従来のMCP設定で起動される時、システムは既存のMCPクライアントと引き続き機能すること。
2. ユーザーが新しいOAuth2認証を使用したい時、システムは明確な移行パスを提供すること。
3. ユーザーがサービスアカウント認証情報とOAuth2トークンの両方を持っている時、システムはOAuth2を優先するが、必要に応じてサービスアカウントにフォールバックすること。
4. システムが古いMCPクライアントで使用されていることを検出する時、システムは通信プロトコルを適宜調整すること。