# 実装計画

- [ ] 1. プロジェクト準備
  - 既存のコードベースを理解し、修正が必要な箇所を特定する
  - 必要な依存関係を追加する（google-auth-oauthlib）
  - _要件: 1.1, 2.1, 3.1_

- [ ] 2. OAuth2認証モジュールの実装
  - [ ] 2.1 OAuth2認証フローの実装
    - Google OAuth2認証のためのクライアントIDとシークレットを設定する
    - 認証URLを生成する関数を実装する
    - 認証コードを受け取るためのローカルサーバーを実装する
    - _要件: 1.1, 1.2, 1.3_
  
  - [ ] 2.2 トークン管理の実装
    - アクセストークンとリフレッシュトークンを保存する機能を実装する
    - トークンをローカルファイルから読み込む機能を実装する
    - トークンの有効期限を確認し、必要に応じて更新する機能を実装する
    - _要件: 1.3, 1.4, 1.5, 1.7_

- [ ] 3. GA4クライアントの修正
  - [ ] 3.1 認証方法の変更
    - サービスアカウント認証からOAuth2認証に変更する
    - GA4 APIクライアントの初期化方法を修正する
    - _要件: 1.5_
  
  - [ ] 3.2 エラーハンドリングの強化
    - 認証エラーを適切に処理する
    - トークンの更新が必要な場合の処理を実装する
    - _要件: 1.4_

- [ ] 4. SSEモードの実装
  - [ ] 4.1 FastMCPの設定変更
    - `mcp.run("stdio")` から `mcp.run("sse")` に変更する
    - SSEサーバーのポートとホストを設定する
    - _要件: 2.1, 2.2, 3.2_
  
  - [ ] 4.2 SSE通信の実装
    - SSE接続を処理する機能を実装する
    - リクエストとレスポンスの形式を適切に設定する
    - エラーメッセージをSSE形式で送信する機能を実装する
    - _要件: 2.3, 2.4, 2.5, 2.6_

- [ ] 5. コマンドラインインターフェースの改善
  - [ ] 5.1 起動オプションの追加
    - ポートとホストを指定するオプションを追加する
    - GA4プロパティIDを指定するオプションを追加する
    - トークンパスを指定するオプションを追加する
    - _要件: 3.2, 3.3_
  
  - [ ] 5.2 ヘルプとドキュメントの追加
    - コマンドラインオプションのヘルプを追加する
    - 使用方法のドキュメントを追加する
    - _要件: 3.1, 3.6_

- [ ] 6. 初回実行時のセットアップガイド
  - [ ] 6.1 初回実行の検出
    - トークンファイルの存在を確認する
    - 初回実行時に適切なガイダンスを表示する
    - _要件: 1.6_
  
  - [ ] 6.2 セットアップガイドの実装
    - OAuth2認証の手順を説明するメッセージを表示する
    - 認証URLを分かりやすく表示する
    - 認証完了後の確認メッセージを表示する
    - _要件: 1.6, 3.6_

- [ ] 7. エラー処理とロギングの強化
  - [ ] 7.1 エラーメッセージの改善
    - ユーザーにわかりやすいエラーメッセージを表示する
    - トラブルシューティングのヒントを提供する
    - _要件: 2.5, 3.6_
  
  - [ ] 7.2 ロギングの強化
    - 重要なイベントをログに記録する
    - デバッグ情報を適切にログに記録する
    - _要件: 3.6_

- [ ] 8. Claude Desktop接続ガイドの作成
  - [ ] 8.1 接続手順の文書化
    - Claude DesktopでのMCP設定方法を説明する
    - 必要な設定パラメータを明確に示す
    - _要件: 4.1_
  
  - [ ] 8.2 トラブルシューティングガイドの作成
    - 一般的な問題と解決策を文書化する
    - エラーメッセージの意味と対処法を説明する
    - _要件: 4.5_

- [ ] 9. テストとデバッグ
  - [ ] 9.1 OAuth2認証フローのテスト
    - 認証URLの生成をテストする
    - トークンの取得と保存をテストする
    - トークンの更新をテストする
    - _要件: 1.1, 1.2, 1.3, 1.4_
  
  - [ ] 9.2 SSE通信のテスト
    - SSEサーバーの起動をテストする
    - クライアント接続をテストする
    - リクエストとレスポンスの処理をテストする
    - _要件: 2.1, 2.2, 2.3, 2.4_
  
  - [ ] 9.3 GA4データ取得のテスト
    - OAuth2認証を使用したGA4 APIアクセスをテストする
    - データ取得と表示をテストする
    - _要件: 1.5, 4.3, 4.4_